{% extends "entrada/base_entrada.html" %}

{% load  static %}

{% block css %}
<link rel="stylesheet" href="{% static 'css/myblog.css' %}">
{% endblock css %}

{% block content %}
{% include "includes/header.html" %}
<style>
    /* Hacer el CKEditor más ancho */
    .django-ckeditor-widget,
    .cke {
        width: 100% !important;
    }

    /* Ajustar el área de contenido */
    .cke_contents {
        width: 100% !important;
    }

</style>

<div class="container text-light" style="min-height: 500px">
        <div class="col-lg-10 offset-lg-1 bg-primary">
            <form method="POST" enctype="multipart/form-data">{% csrf_token %}

                <div class="col-12 mt-3 mb-1">
                    <div class="py-1">
                        <p class="h3 text-center">Agregar Nuevo Post</p>
                    </div>
                </div>

                <!-- Fila 1: Switches, Tags, Usuario, Categoría -->
                <div class="form-row mb-2">
                    <div class="col-3">
                        <p class="mb-1">Usuario</p>
                        <input type="text" value="{{ user.email }}" class="form-control form-control-sm" readonly>
                    </div>

                    <div class="col-md-6 mb-2">
                        <p class="mb-1">Título</p>
                        {{form.title}}
                    </div>
                    <div class="col-auto text-center px-2">
                        <p class="mb-1 small">Home</p>
                        {{form.in_home}}
                    </div>
                    <div class="col-auto text-center px-2">
                        <p class="mb-1 small">Público</p>
                        {{form.public}}
                    </div>
                    <div class="col-auto text-center px-2">
                        <p class="mb-1 small">Portada</p>
                        {{form.portada}}
                    </div>
                </div>

                <!-- Fila 2: Título y Resumen -->
                <div class="form-row mb-2">
                    <div class="col-4">
                        <p class="mb-1">Categoría</p>
                        {{ form.category }}
                    </div>
                    <div class="col-3">
                        <p class="mb-1">Tags</p>
                        {{form.tag}}
                    </div>
                    <div class="col-5 mb-2">
                        <p class="mb-1">Resumen</p>
                        {{form.resume}}
                    </div>
                </div>

                <!-- Editor de contenido -->
                <div class="form-row mb-2">
                    <div class="col-12">
                        <button type="button" id="quick-code-btn" class="btn btn-sm btn-warning mb-2" title="Selecciona texto y haz clic aquí (o usa Ctrl+K)">
                            <i class="fa fa-code"></i> Convertir a Código
                        </button>
                        {{form.media}}
                        {{form.content}}
                    </div>
                </div>

                <!-- Imagen -->
                <div class="form-row mb-2">
                    <div class="col-12">
                        <p class="mb-1">Imagen</p>
                        {{form.image}}
                    </div>
                </div>

                <!-- Botón de guardar -->
                <div class="form-row">
                    <div class="col-12 mt-2 mb-3">
                        <button type="submit" class="text-white btn btn-success btn-block">Guardar</button>
                    </div>
                </div>
            </form>
        </div>

</div>


<script>
// Script para convertir texto seleccionado en code snippet con Ctrl+K
document.addEventListener('DOMContentLoaded', function() {
    // Esperar a que CKEditor esté completamente cargado
    if (typeof CKEDITOR !== 'undefined') {
        CKEDITOR.on('instanceReady', function(evt) {
            var editor = evt.editor;

            // Verificar si el editor tiene el plugin codesnippet
            if (editor.plugins.codesnippet) {

                // Función para convertir texto a code snippet
                function convertToCodeSnippet() {
                    var selection = editor.getSelection();
                    var selectedText = selection.getSelectedText();

                    if (selectedText && selectedText.trim() !== '') {
                        // Escapar caracteres especiales HTML
                        var escapedText = selectedText
                            .replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;')
                            .replace(/"/g, '&quot;')
                            .replace(/'/g, '&#39;');

                        // Crear el code snippet
                        var codeSnippet = '<pre><code class="language-python">' + escapedText + '</code></pre>';

                        // Eliminar la selección actual e insertar el code snippet

                        editor.insertHtml(codeSnippet);

                        console.log('✅ Code snippet insertado');
                    } else {
                        // Si no hay texto seleccionado, abrir el diálogo normal
                        editor.execCommand('codesnippet');
                    }
                }

                // Agregar comando personalizado
                editor.addCommand('quickCodeSnippet', {
                    exec: convertToCodeSnippet
                });

                // Asignar atajo de teclado: Ctrl+K
                editor.setKeystroke(CKEDITOR.CTRL + 75, 'quickCodeSnippet');

                // Conectar el botón HTML con la función
                document.getElementById('quick-code-btn').addEventListener('click', function(e) {
                    e.preventDefault();
                    convertToCodeSnippet();
                });

                console.log('✅ Atajo Ctrl+K y botón HTML configurado');
            }
        });
    }
});
</script>

{% endblock content %}