{% extends "users/base_users.html" %}
{% load static %}

{% block content %}

{% include "includes/header.html" %}

<style>
    .chat-container {
        max-width: 500px;
        margin: 20px auto;
        padding: 0 50px;
    }

    .header-chat {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 10px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        margin-bottom: 10px;
        text-align: center;
    }

    .header-chat h2 {
        margin: 0;
        font-weight: 500;
        font-size: 30px;
    }

    .users-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .users-card-header {
        background-color: #007bff;
        color: white;
        padding: 2px;
        border-bottom: none;
    }

    .users-card-header h3 {
        margin: 0;
        color: white;
        font-weight: 500;
    }

    .users-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .user-item {
        background: white;
        padding: 5px 10px;
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.3s;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .user-item:last-child {
        border-bottom: none;
    }

    .user-item:hover {
        background-color: #f8f9fa;
        transform: translateX(5px);
    }

    .user-item.online {
        border-left: 4px solid #28a745;
    }

    .user-item.offline {
        border-left: 4px solid #dc3545;
        opacity: 0.7;
    }

    .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
        flex: 1;
    }

    .user-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 18px;
    }

    .user-details {
        flex: 1;
    }

    .user-name {
        text-decoration: none;
        color: #333;
        font-weight: 600;
        font-size: 1.1rem;
        display: block;
        transition: color 0.3s;
    }

    .user-name:hover {
        color: #007bff;
        text-decoration: none;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.3s;
    }

    .status-badge.online {
        background-color: #d4edda;
        color: #155724;
    }

    .status-badge.offline {
        background-color: #f8d7da;
        color: #721c24;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        animation: pulse 2s infinite;
    }

    .status-dot.online {
        background-color: #28a745;
    }

    .status-dot.offline {
        background-color: #dc3545;
        animation: none;
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }

    .section-divider {
        padding: 2px 20px;
        background-color: #f8f9fa;
        border-top: 2px solid #e9ecef;
        border-bottom: 2px solid #e9ecef;
        font-weight: 600;
        color: #6c757d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }

    .empty-state i {
        font-size: 60px;
        margin-bottom: 20px;
        color: #ddd;
    }

    @media (max-width: 768px) {
        .chat-container {
            padding: 0 10px;
        }

        .header-chat h2 {
            font-size: 1.5rem;
        }

        .user-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .status-badge {
            align-self: flex-start;
        }
    }
</style>

<div class="chat-container">
    <!-- Header -->
    <div class="header-chat">
        <i class="fas fa-comments mb-3" style="font-size: 50px;"></i>
        <h2>{{ request.user.full_name }}</h2>
    </div>

    <!-- Card de Usuarios -->
    <div class="users-card">
        <div class="users-card-header">
            <h3><i class="fas fa-users mr-2"></i>Usuarios</h3>
        </div>

        <ul class="users-list" id="usersList">
            <!-- Los usuarios se cargarán aquí con JavaScript -->
        </ul>
    </div>
</div>

<script>
    // Datos iniciales de usuarios desde el backend
    const usersData = {
        {% for u in users %}
        {% if u.id != user.id %}
        {{ u.id }}: {
            id: {{ u.id }},
            name: "{{ u.full_name }}",
            initial: "{{ u.full_name|slice:':1'|upper }}",
            isOnline: {% if u.is_online %}true{% else %}false{% endif %}
        },
        {% endif %}
        {% endfor %}
    };

    // Función para actualizar solo el estado de un usuario específico
    function updateUserStatus(userId, isOnline) {
        const userItem = document.getElementById(`user-item-${userId}`);
        const statusBadge = document.getElementById(`status-${userId}`);

        if (!userItem || !statusBadge) return;

        // Actualizar clases del item
        if (isOnline) {
            userItem.classList.remove('offline');
            userItem.classList.add('online');
        } else {
            userItem.classList.remove('online');
            userItem.classList.add('offline');
        }

        // Actualizar badge de estado
        statusBadge.className = `status-badge ${isOnline ? 'online' : 'offline'}`;
        statusBadge.innerHTML = `
            <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
            ${isOnline ? 'En línea' : 'Desconectado'}
        `;

        // Actualizar datos locales
        if (usersData[userId]) {
            usersData[userId].isOnline = isOnline;
        }
    }

    // Función para crear un item de usuario
    function createUserItem(user, isOnline) {
        const li = document.createElement('li');
        li.className = `user-item ${isOnline ? 'online' : 'offline'}`;
        li.id = `user-item-${user.id}`;

        const chatUrl = "{% url 'chat_room' 999999 %}".replace('999999', user.id);

        li.innerHTML = `
            <div class="user-info">
                <div class="user-avatar">${user.initial}</div>
                <div class="user-details">
                    <a href="${chatUrl}" class="user-name">
                        ${user.name}
                    </a>
                </div>
            </div>
            <span class="status-badge ${isOnline ? 'online' : 'offline'}" id="status-${user.id}">
                <span class="status-dot ${isOnline ? 'online' : 'offline'}"></span>
                ${isOnline ? 'En línea' : 'Desconectado'}
            </span>
        `;

        return li;
    }

    // Función para renderizar la lista completa de usuarios
    function renderUsersList() {
        const usersList = document.getElementById('usersList');

        // Separar usuarios en línea y offline
        const onlineUsers = [];
        const offlineUsers = [];

        Object.values(usersData).forEach(user => {
            if (user.isOnline) {
                onlineUsers.push(user);
            } else {
                offlineUsers.push(user);
            }
        });

        // Ordenar alfabéticamente
        onlineUsers.sort((a, b) => a.name.localeCompare(b.name));
        offlineUsers.sort((a, b) => a.name.localeCompare(b.name));

        // Limpiar lista
        usersList.innerHTML = '';

        // Agregar usuarios en línea
        if (onlineUsers.length > 0) {
            const onlineHeader = document.createElement('li');
            onlineHeader.className = 'section-divider';
            onlineHeader.innerHTML = `<i class="fas fa-circle text-success mr-2"></i>En Línea (${onlineUsers.length})`;
            usersList.appendChild(onlineHeader);

            onlineUsers.forEach(user => {
                usersList.appendChild(createUserItem(user, true));
            });
        }

        // Agregar usuarios offline
        if (offlineUsers.length > 0) {
            const offlineHeader = document.createElement('li');
            offlineHeader.className = 'section-divider';
            offlineHeader.innerHTML = `<i class="fas fa-circle text-danger mr-2"></i>Desconectados (${offlineUsers.length})`;
            usersList.appendChild(offlineHeader);

            offlineUsers.forEach(user => {
                usersList.appendChild(createUserItem(user, false));
            });
        }

        // Si no hay usuarios
        if (onlineUsers.length === 0 && offlineUsers.length === 0) {
            const emptyState = document.createElement('li');
            emptyState.className = 'empty-state';
            emptyState.innerHTML = `
                <i class="fas fa-user-slash"></i>
                <h5>No hay usuarios disponibles</h5>
                <p>No se encontraron usuarios para chatear</p>
            `;
            usersList.appendChild(emptyState);
        }
    }

    // Actualizar estados de usuarios (versión optimizada)
    function actualizarEstados() {
        fetch("{% url 'chat_home' %}?json=1", {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            let cambios = false;

            // Actualizar solo los usuarios que cambiaron de estado
            Object.keys(data).forEach(userId => {
                const newStatus = data[userId];
                const currentStatus = usersData[userId]?.isOnline;

                if (currentStatus !== newStatus) {
                    updateUserStatus(parseInt(userId), newStatus);
                    cambios = true;
                }
            });

            // Si hubo cambios, re-renderizar para actualizar los contadores
            if (cambios) {
                renderUsersList();
            }
        })
        .catch(error => console.error('Error actualizando estados:', error));
    }

    // Enviar ping para mantener al usuario actual como "online"
    function enviarPing() {
        fetch("{% url 'ping' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            }
        })
        .then(response => response.json())
        .catch(error => console.error('Error en ping:', error));
    }

    // Renderizar inicial
    renderUsersList();

    // Actualizar estados cada 2 segundos
    setInterval(actualizarEstados, 2000);

    // Enviar ping cada 2 segundos
    setInterval(enviarPing, 2000);

    // Enviar ping inmediatamente al cargar
    enviarPing();
</script>

{% endblock content %}