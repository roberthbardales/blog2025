{% extends "entrada/base_entrada.html" %}
{% load static %}

{% block title %}{{ entry.title }}{% endblock title %}
{% block description %}
<meta name="description" content="{{ entry.resume }}">
{% endblock description %}
{% block tags %}
<meta name="keywords" content="
    {% for t in entry.tag.all %}
        {{ t.name }},
    {% endfor %}
">
{% endblock tags %}

{% block content %}

{% include "includes/header.html" %}

<style>
    .card {
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .card-header-custom {
        background-color: #0551a1 !important;
        color: white !important;
        border-bottom: none;
    }

    .entry-header {
        /* background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); */
        background-color: #007bff;
        color: white;
        padding: 10px;
        border-radius: 15px;
        margin-bottom: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }

    .entry-header h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 15px;
    }

    .entry-resume {
        background-color: white;
        padding: 10px;
        border-radius: 10px;
        border-left: 5px solid #007bff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 15px;
    }

    .entry-content {
        background-color: rgb(255, 255, 255);
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        min-height: 600px;
        line-height: 1.5;
    }

    .sidebar-card {

        position: sticky;
        top: 90px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    .sidebar-card-2 {

        position: sticky;
        top: 430px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }


    .entry-image {
        width: 100%;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .like-section {
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-top: 20px;
    }

    .btn-like {
        transition: all 0.3s;
    }

    .btn-like:hover {
        transform: scale(1.05);
    }

    .comment-card {
        font-size: 15px;
        border-left: 2px solid #007bff;
        background-color: #e3efff;
        border-radius: 8px;
        padding: 4px;
        margin-bottom: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        transition: all 0.3s;
    }

    /* .comment-card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        transform: translateX(5px);
    } */

    .reply-card {
        margin-left: 15px;
        border-left: 3px solid #28a745;
        background-color: #e6f4ec;
    }

    .comment-author {
        color: #007bff;
        font-weight: 600;
        text-decoration: none;
    }

    .comment-author:hover {
        text-decoration: underline;
    }

    .comment-form {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border: 2px dashed #dee2e6;
    }

    .action-buttons .btn {
        margin: 5px 0;
    }

    .meta-info {
        display: flex;
        align-items: center;
        gap: 15px;
        font-size: 0.9rem;
        color: #6c757d;
        margin-top: 10px;
    }

    .meta-info i {
        color: #007bff;
    }

    .badge-category {
        background-color: #007bff;
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        margin-bottom: 15px;
        display: inline-block;
    }

    /* Estilos para código */
    .post-content pre {
        background-color: #282c34;
        color: #abb2bf;
        padding: 5px;
        border-radius: 5px;
        overflow-x: auto;
        font-size: 14px;
        margin: 10px 0;
    }

    .code-container {
        position: relative;
        margin-bottom: 5px;
        margin: 5px 0;
    }

    .copy-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 6px 12px;
        font-size: 12px;
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.3s;
    }

    .copy-btn:hover {
        background-color: #0056b3;
        transform: translateY(-2px);
    }

    .copy-btn svg {
        width: 16px;
        height: 16px;
    }

    .empty-comments {
        text-align: center;
        padding: 8px;
        color: #6c757d;
    }


</style>

<div class="container" style="padding: 30px 0;">
    <div class="row">
        <!-- Contenido Principal -->
        <div class="col-lg-9">

            <!-- Header del Post -->
            <div class="entry-header text-center">
                <h1>{{ entry.title }}</h1>
                <div class="meta-info text-white">
                    <span><i class="far fa-calendar-alt mr-1"></i>{{ entry.created|date:"d M Y" }}</span>
                    <span><i class="far fa-clock mr-1"></i>{{ entry.created|date:"H:i" }}</span>
                    <!-- <span><i class="far fa-user mr-1"></i>Autor</span> -->
                </div>
            </div>

            <!-- Resumen -->
            <div class="entry-resume">
                <h5 class="text-primary "></h5>
                <p class="mb-0">{{ entry.resume }}</p>
            </div>

            <!-- Contenido del Post -->
            <div class="entry-content">
                <div class="post-content text-justify">
                    {{ entry.content|safe }}
                </div>
                <div class="mt-4 pt-3 border-top">
                    <small class="text-muted">
                        <i class="far fa-edit mr-1"></i>Última modificación: {{ entry.modified|date:"d M Y H:i" }}
                    </small>
                </div>
            </div>


            <!-- Sección de Comentarios -->
            <div class="mt-4">
                <div class="card">
                    <div class="card-heade card-header-custom">
                        <h5 class="mb-0">
                            <i class="fas fa-comments mr-2"></i>Comentarios ({{ main_comments.count }})
                        </h5>
                    </div>
                    <div class="card-body">
                        {% for comment in main_comments %}
                        <div class="comment-card">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <a href="{% url 'entrada_app:view_profile' comment.user.pk %}" class="comment-author">
                                        <i class="fas fa-user-circle mr-1"></i>{{ comment.user.full_name }}
                                    </a>
                                    <small class="text-muted ml-2">
                                        <i class="far fa-clock mr-1"></i>{{ comment.created|date:"d M Y H:i" }}
                                    </small>
                                </div>
                            </div>
                            <p class="mb-1">{{ comment.content }}</p>

                            {% if user.is_authenticated %}
                            <div class="">
                                <a href="#" onclick="document.getElementById('reply-{{ comment.id }}').style.display='block'; return false;"
                                   class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-reply mr-1"></i>Responder
                                </a>
                                {% if comment.user == user %}
                                <form method="post" action="{% url 'entrada_app:delete_comment' comment.id %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-trash mr-1"></i>Eliminar
                                    </button>
                                </form>
                                {% endif %}
                            </div>

                            <!-- Formulario de Respuesta -->
                            <div id="reply-{{ comment.id }}" style="display:none;" class="mt-1 comment-form">
                                <form method="post" action="{% url 'entrada_app:add_comment' entry.slug %}">
                                    {% csrf_token %}
                                    {{ comment_form.as_p }}
                                    <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                    <button type="submit" class="btn btn-primary btn-sm">
                                        <i class="fas fa-paper-plane mr-1"></i>Enviar Respuesta
                                    </button>
                                    <button type="button" onclick="document.getElementById('reply-{{ comment.id }}').style.display='none'"
                                            class="btn btn-secondary btn-sm">
                                        Cancelar
                                    </button>
                                </form>
                            </div>
                            {% endif %}

                            <!-- Respuestas -->
                            {% for reply in comment.replies.all %}
                            <div class="comment-card reply-card mt-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <a href="{% url 'entrada_app:view_profile' reply.user.pk %}" class="comment-author">
                                            <i class="fas fa-reply mr-1"></i>{{ reply.user.full_name }}
                                        </a>
                                        <small class="text-muted ml-2">
                                            <i class="far fa-clock mr-1"></i>{{ reply.created|date:"d M Y H:i" }}
                                        </small>
                                    </div>
                                </div>
                                <p class="mb-1">{{ reply.content }}</p>

                                {% if user.is_authenticated and reply.user == user %}
                                <div class="mt-1">
                                    <form method="post" action="{% url 'entrada_app:delete_comment' reply.id %}" class="d-inline">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-trash mr-1"></i>Eliminar
                                        </button>
                                    </form>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% empty %}
                        <div class="empty-comments">
                            <i class="far fa-comment-dots"></i>
                            <h5 class="mt-3">No hay comentarios aún</h5>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Formulario de Nuevo Comentario -->
                {% if user.is_authenticated %}
                <div class="card mt-4">
                    <div class="card-header card-header-custom">
                        <h5 class="mb-0"><i class="fas fa-comment-dots mr-2"></i>Agregar un comentario</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" action="{% url 'entrada_app:add_comment' entry.slug %}">
                            {% csrf_token %}
                            {{ comment_form.as_p }}
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane mr-2"></i>Publicar Comentario
                            </button>
                        </form>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle mr-2"></i>
                    Debes <a href="{% url 'users_app:user-login' %}" class="alert-link">iniciar sesión</a> para comentar.
                </div>
                {% endif %}
            </div>

        </div>

        <!-- Sidebar -->
        <div class="col-lg-3">
                <div class="sidebar-card">
                    <div class="card-header-custom text-center py-3">
                        <h5 class="mb-0"><i class="fas fa-info-circle mr-2"></i>{{ entry.category }}</h5>
                        <!-- <span class="badge-category">
                            <i class="fas fa-folder mr-1"></i>{{ entry.category }}
                        </span> -->
                    </div>
                    <div class="p-3">
                        <img class="entry-image" src="{{ entry.image.url }}" alt="{{ entry.title }}">

                        <!-- Botones de Acción -->
                        <div class="action-buttons">
                            {% if user.is_authenticated %}
                                {% if not is_favorito %}
                                <button type="button" class="btn btn-primary btn-block" data-toggle="modal" data-target="#guardarModal">
                                    <i class="fas fa-star mr-2"></i>Añadir a favoritos
                                </button>
                                {% else %}
                                <form method="POST" action="{% url 'favoritos_app:add-favoritos2' entry.id %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger btn-block">
                                        <i class="fas fa-star mr-2"></i>Quitar de favoritos
                                    </button>
                                </form>
                                {% endif %}

                                {% if user.ocupation == User.ADMINISTRADOR or user.is_superuser %}
                                <a href="{% url 'entrada_app:update-entrada' entry.id %}" class="btn btn-success btn-block">
                                    <i class="fas fa-edit mr-2"></i>Modificar
                                </a>
                                {% endif %}
                            {% else %}
                            <div class="alert alert-info text-center p-2">
                                <p class="mb-2"><small>¿Quieres guardar este post?</small></p>
                                <a href="{% url 'users_app:user-register' %}" class="btn btn-outline-primary btn-sm btn-block">
                                    <i class="fas fa-user-plus mr-1"></i>Regístrate
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                <!-- Sección de Likes -->
                 <hr>
                <div class=" like-section">
                    <h5 class="mb-3"><i class="fas fa-heart mr-2 text-danger"></i>¿Te gustó este artículo?</h5>
                    {% if user.is_authenticated %}
                    <form action="{% url 'entrada_app:toggle-like' entry.id %}" method="post" class="d-inline">
                        {% csrf_token %}
                        {% if has_liked %}
                        <button type="submit" class="btn btn-danger btn-like">
                            <i class="fas fa-heart-broken mr-2"></i>Quitar Like
                        </button>
                        {% else %}
                        <button type="submit" class="btn btn-primary btn-like">
                            <i class="fas fa-heart mr-2"></i>Dar Like
                        </button>
                        {% endif %}
                    </form>
                    <span class="ml-3">
                        <i class="fas fa-heart text-danger mr-1"></i>
                        <strong>{{ likes_count }}</strong>
                        <i class="bi bi-hand-thumbs-up-fill text-primary"></i>
                    </span>
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle mr-2"></i>
                        Debes <a href="{% url 'users_app:user-login' %}" class="alert-link">iniciar sesión</a> para dar like.
                        <span class="ml-3">
                            <i class="fas fa-heart text-danger mr-1"></i>
                            <strong>{{ likes_count }}</strong> likes
                        </span>
                    </div>
                    {% endif %}
                </div>
                </div>


        </div>

    </div>
</div>

<!-- Modal Guardar en Favoritos -->
<div class="modal fade" id="guardarModal" tabindex="-1" role="dialog" aria-labelledby="guardarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="guardarModalLabel">
                    <i class="fas fa-star mr-2"></i>Guardar en Favoritos
                </h5>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Cerrar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form method="POST" action="{% url 'favoritos_app:add-favoritos2' entry.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="form-group">
                        <label for="kword_grupo" class="font-weight-bold">
                            <i class="fas fa-folder mr-2"></i>Selecciona un grupo:
                        </label>
                        <select name="kword_grupo" id="kword_grupo" class="form-control" required>
                            {% if contexto_grupos %}
                                {% for grupo in contexto_grupos %}
                                <option value="{{ grupo.id }}" {% if grupo_activo == grupo.name %}selected{% endif %}>
                                    {{ grupo.name }}
                                </option>
                                {% endfor %}
                            {% else %}
                                <option value="0" selected>General</option>
                            {% endif %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times mr-1"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save mr-1"></i>Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Script para copiar código -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.post-content pre code').forEach((block) => {
        if (block.parentNode.classList.contains('code-container')) return;

        const container = document.createElement('div');
        container.classList.add('code-container');

        const button = document.createElement('button');
        button.classList.add('copy-btn');
        button.innerHTML = `<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 16h8M8 12h8M8 8h8M4 20h16a2 2 0 002-2V6a2 2 0 00-2-2H4a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
        </svg> Copiar`;

        const pre = block.parentNode;
        pre.parentNode.replaceChild(container, pre);
        container.appendChild(pre);
        container.appendChild(button);

        button.addEventListener('click', () => {
            navigator.clipboard.writeText(block.innerText)
            .then(() => {
                button.innerHTML = '<i class="fas fa-check"></i> ¡Copiado!';
                button.style.backgroundColor = '#28a745';
                setTimeout(() => {
                    button.innerHTML = `<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 16h8M8 12h8M8 8h8M4 20h16a2 2 0 002-2V6a2 2 0 00-2-2H4a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg> Copiar`;
                    button.style.backgroundColor = '#007bff';
                }, 2000);
            })
            .catch(() => alert('Error al copiar el código'));
        });
    });
});
</script>

{% endblock content %}